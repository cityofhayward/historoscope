<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Hayward Historic Maps</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
  <link rel="stylesheet" href="css/leaflet-measure.css" />
  <link rel="stylesheet" href="css/app2.css" />

  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet-src.js"></script>
  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.1.3"></script>
            <script src="js/L.Map.Sync2.js"></script>

    <!-- Esri Leaflet Geocoder -->
   <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.9/dist/esri-leaflet-geocoder.css">
   <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.8"></script>

</head>
<script>

</script>
<body>
<div id="sidr-right"></div>
  <div id="map1">
    <select name="basemaps-left" id="basemapsLeft" onChange="changeBasemap(basemapsLeft)">
    </select>
  </div>
  <div id="map2">
    <select name="basemaps-right" id="basemapsRight" onChange="changeBasemap(basemapsRight)">
    </select>
  </div>
</div>

<script>
    var mapLeft = L.map('map1').setView([37.67, -122.09], 15);

    // create the geocoding control and add it to the map
      var searchControl = L.esri.Geocoding.geosearch({
        useMapBounds: false
      }).addTo(mapLeft);

      // create an empty layer group to store the results and add it to the map
      var results = L.layerGroup().addTo(mapLeft);

      // listen for the results event and add every result to the map
      searchControl.on("results", function(data) {
          results.clearLayers();
          for (var i = data.results.length - 1; i >= 0; i--) {
              results.addLayer(L.marker(data.results[i].latlng));
          }
      });

    // Create new crosshair for the Left map
    var crosshairIcon = L.icon({
        iconUrl: 'images/crosshairs.svg',
        iconSize: [200, 200], // size of the icon
        iconAnchor: [100, 100] // point of the icon which will correspond to marker's location
    });

    // Add crosshair to left map
    crosshairL = new L.marker(mapLeft.getCenter(), { icon: crosshairIcon, clickable: false });
    crosshairL.addTo(mapLeft);

  var leftLayer, rightLayer;
  var baseURL = "https://maps.hayward-ca.gov/arcgis/rest/services/Ext_Basemaps";
  var defaultLeftLayer = "AerialPhotoHybrid_2017";
  var defaultRightLayer = "AerialPhoto_1968_12inch";

  var res2 = L.esri.get(baseURL, {},
    function (error, response) {
      if (error) {
        console.log(error)
      } else {
      var dropdownContent = [];
      var dropdownLeft = document.getElementById("basemapsLeft");
        var dropdownRight = document.getElementById("basemapsRight");
      for (i=0; i<response.services.length;  i++) {
        console.log(response.services[i]);
        console.log(response.services[i].name.split('/')[1]);
        var thisLayerString = response.services[i].name.split('/')[1];
        var thisLayerName = thisLayerString;
        dropdownContent.push(response.services[i].name.split('/')[1].split('_').join(' '));
        var thisDropdown = response.services[i].name.split('/')[1].split('_').join(' ');
        var elLeft = document.createElement("option");
        elLeft.textContent = thisDropdown;
        elLeft.value = thisLayerString;
        dropdownLeft.appendChild(elLeft);
        var elRight = document.createElement("option");
        elRight.textContent = thisDropdown;
        elRight.value = thisLayerString;
        dropdownRight.appendChild(elRight);
        thisLayerName = L.esri.tiledMapLayer({
          url: baseURL.concat('/', thisLayerString, '/MapServer'),
          maxZoom: 21
        });
        if (thisLayerString == defaultLeftLayer) {
          leftLayer = thisLayerName;
          mapLeft.addLayer(leftLayer);
          elLeft.selected = true;
        }
        if (thisLayerString == defaultRightLayer) {
          rightLayer = thisLayerName;
          mapRight.addLayer(rightLayer);
          elRight.selected = true;
        }
        console.log(thisLayerName);

      }
      console.log(dropdownContent.length);
    }
  });

    var mapRight = L.map('map2').setView([37.67, -122.09], 15);

    // Add in a crosshair for the Right map
    crosshairR = new L.marker(mapRight.getCenter(), { icon: crosshairIcon, clickable: false });
    crosshairR.addTo(mapRight);

    function setBasemap(basemap, mapSide) {
        if (mapSide === "basemapsLeft") {
            mapLeft.removeLayer(leftLayer);
            if (basemap === 'Streets') {
                leftLayer = L.esri.basemapLayer(basemap);
            } else {
                leftLayer = L.esri.tiledMapLayer({
                  url: baseURL.concat('/', basemap, '/MapServer'),
                  maxZoom: 21
                });
            }
            mapLeft.addLayer(leftLayer);
        } else if (mapSide === "basemapsRight") {
            mapRight.removeLayer(rightLayer);
            if (basemap === 'Streets') {
                rightLayer = L.esri.basemapLayer(basemap);
            } else {
                rightLayer = L.esri.tiledMapLayer({
                  url: baseURL.concat('/', basemap, '/MapServer'),
                  maxZoom: 21
                });
            }
            mapRight.addLayer(rightLayer);
        }
    }

  function changeBasemap(basemaps) {
        var whichMap = basemaps.id;
        //Need to force this to set because IE doesn't recognize normal dropdown onchange events
      //  var thisIndexToSet = document.getElementById("basemapsRight").selectedIndex;
      //  basemaps.options[thisIndexToSet].selected = true;
      if (whichMap === "basemapsRight") {
          document.getElementById("basemapsLeft").focus();
      } else {
          document.getElementById("basemapsRight").focus();
      }

        var basemap = basemaps.value;
        setBasemap(basemap, whichMap);
  }

    mapLeft.sync(mapRight);
    mapRight.sync(mapLeft);
  //  mapLeft.on('zoomend', function () {
  //      console.log(mapLeft.getZoom());
  //  });

    // Move the crosshair to the center of the map when the user pans
    mapLeft.on('move', function (e) {
        crosshairL.setLatLng(mapLeft.getCenter());
        crosshairR.setLatLng(mapRight.getCenter());
        document.getElementById("basemapsRight").focus();
    });
    // Move the crosshair to the center of the map when the user pans
    mapRight.on('move', function (e) {
        crosshairR.setLatLng(mapRight.getCenter());
        crosshairL.setLatLng(mapLeft.getCenter());
        document.getElementById("basemapsLeft").focus();
    });
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sidr/2.2.1/jquery.sidr.min.js"></script>
</body>
</html>
